{% extends "layout.html" %}

{% block content %}
<head>
    <title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 10px;
            text-align: center;
        }

        .table-dark {
            background-color: #343a40;
            color: white;
        }

        .error {
            border: 2px solid red; /* Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙØ§Ø±ØºØ© */
        }
    </style>
</head>

<h2 class="text-center my-4 text-primary">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØµÙˆØª ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø© -->
<div class="search-container text-center">
    <h3>Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
    <input type="text" id="text-search" class="form-control w-50 d-inline" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">
    <button class="btn btn-primary" onclick="searchByText()">Ø¨Ø­Ø«</button>
    <button class="btn btn-secondary" onclick="startVoiceRecognition()">ğŸ”Š Ø¨Ø­Ø« Ø¨Ø§Ù„ØµÙˆØª</button>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
<div class="table-responsive mt-4">
    <table class="table table-bordered text-center">
        <thead class="table-dark">
            <tr>
                {% if reports %}
                    {% for key in reports[0].keys() %}
                        <th>{{ key.replace('_', ' ') }}</th>
                    {% endfor %}
                {% endif %}
            </tr>
        </thead>
        <tbody id="report-table-body">
            {% for report in reports %}
            <tr id="row-{{ report['Ø§Ù„Ù…Ø´Ø±ÙˆØ¹']|replace(' ', '_') }}">
                {% for key, value in report.items() %}
                <td>{{ value if value is not none else '-' }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function searchByText() {
        let projectName = document.getElementById('text-search').value.trim().replace(/\s+/g, '_');
        fetch('/search_reports', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ project_name: projectName })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            updateReportTable(data, projectName);
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        });
    }

    function startVoiceRecognition() {
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'ar-SA'; // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„ØºØ© Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.start();

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            document.getElementById('text-search').value = transcript; // Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
            searchByText(); // Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø«
        };

        recognition.onerror = function(event) {
            console.error('Error occurred in recognition: ' + event.error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        };
    }

    function updateReportTable(data, projectName) {
        let tableBody = document.getElementById('report-table-body');
        tableBody.innerHTML = '';

        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="15" class="text-center text-danger">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</td></tr>';
        } else {
            data.forEach(report => {
                let row = `<tr id="row-${report['Ø§Ù„Ù…Ø´Ø±ÙˆØ¹'].replace(/\s+/g, '_')}">`;
                Object.values(report).forEach(value => {
                    row += `<td>${value !== null ? value : '-'}</td>`;
                });
                row += `</tr>`;
                tableBody.innerHTML += row;
            });
        }
    }
</script>
{% endblock %}